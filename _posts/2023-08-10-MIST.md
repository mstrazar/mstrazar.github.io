---
layout: post
title: "Chemical formula transformers"  
date:   2023-08-02 04:00:30 +0100
author: "Martin Stra≈æar"
categories: computational_metabolomics deep_learning graph_neural_networks 
---

On the smallest of scales, we can measure molecules in a biological sample


How can we measure elements at scales this small?

Bond breaking 

m/z

Intact molecules versus fragments.


Our latest metabolite prediction framework, MIST, was developed by 


Metabolite Inference with Spectrum Transformers (MIST)

<a href="">Sam Goldman</a>, 

and supervised by 
<a href="">
Conor Coley
</a> (MIT Chemical Engineering)

and is available in open source.




<figure style="float: left; margin-left: 0 px;">
<img src="/img/posts/mist/mist_header.png">
<figcaption align="center"><font color="gray">

Overview of the MIST architecture. Mass spectrometry readouts are collected from
different biological samples and transformed into molecular fingerprints using
MIST. Fragments of indiivdual molecules are observed as peaks at different
mass-to-charge (m/z) ratios and their relative abundance is detected as ion
intensity (peak height). As some bonds in a molecule are stronger than others,
certain fragments are more likely to appear, which is seen as higher intensity
at the corresponding m/z. 

Typically, individual m/z values correspond precisely to a molecular formula for a given substructure.

Since the fragmentation patterns ("peak formulae") are highly dependent
on molecular structure, a model can be trained to reconstruct the underlying
structure by observing the mass spectrum. 

</font></figcaption>
</figure>

The input consist of fragmentation spectra obtained with liquid chromatography/tandem mass spectromery (LC-MS/MS) and predict the identities of molecules predicted to pertain to the observed spectra.


Graph neural network 

Recursive dependencies between fragments:

Smaller fragments break down into further smaller fragments.

- Data augmentation

- Multitask loss, prediction of fingerprints and annotation of fragments.

Applications: discovery of alkaloids and dipeptides that are more prevalent in inflammatory bowel disease (IBD).


Outlook:  
* discovery of unknown metabolites and natural products.
* bacterial cultures
* drugs
* synthetic molecules




Learn more in Nature Machine Intelligence and biorXiv, and try out MIST on 

GitHub.



---

BioRender / nat comm



/Users/mstrazar/Dev/data/metabolites/output/standards_v2/MSMS/metadata_HMDB_known.csv 

Interesting compounds:

HMDB0015214_msms_2242161_2840508_experimental	HILIC_pos	582.2729463	60	HMDB0015214	CNC1C(OC2C(OC3C(O)C(O)C(NC(=N)N)C(O)C3NC(=N)N)OC(C)C2(O)C=O)OC(CO)C(O)C1O	Streptomycin
mxp1748_M1748_M_H_combinedV	HILIC_pos	749.5158	8.77	HMDB0014352	CCC1OC(=O)C(C)C(OC2CC(C)(OC)C(O)C(C)O2)C(C)C(OC2OC(C)CC(N(C)C)C2O)C(C)(O)CC(C)CN(C)C(C)C(O)C1(C)O	Azithromycin
mxp1583_M1583_M_2H2__combinedV	HILIC_pos	724.7224	8.9	HMDB0014653	CNC(CC(C)C)C(=O)NC1C(=O)NC(CC(N)=O)C(=O)NC2C(=O)NC3C(=O)NC(C(=O)NC(C(=O)O)c4cc(O)cc(O)c4-c4cc3ccc4O)C(O)c3ccc(c(Cl)c3)Oc3cc2cc(c3OC2OC(CO)C(O)C(O)C2OC2CC(C)(N)C(O)C(C)O2)Oc2ccc(cc2Cl)C1O	Vancomycin
mxp2340_M2340_M_H_combinedV	HILIC_pos	407.221	7.34	HMDB0015564	CCCC1CC(C(=O)NC(C(C)O)C2OC(SC)C(O)C(O)C2O)N(C)C1	Lincomycin
mxp1075_M0679_M_H_combinedV	HILIC_pos	350.1169	3.35	HMDB0014559	CC1(C)SC2C(NC(=O)C(N)c3ccccc3)C(=O)N2C1C(=O)O	Ampicillin



Vitamins

mxp0756_M0320_M_H2O_H_combinedV	HILIC_pos	269.2263	1.54	HMDB0000305	CC(C=CC1=C(C)CCCC1(C)C)=CC=CC(C)=CCO	Vitamin A


Neuro

mxp0912_M0199_M_H_combinedV	HILIC_pos	233.1285	2.42	HMDB0001389	COc1ccc2[nH]cc(CCNC(C)=O)c2c1	Melatonin
mxp1240_M1240_M_H_combinedV	HILIC_pos	195.0877	2.82	HMDB0001847	Cn1c(=O)c2c(ncn2C)n(C)c1=O	Caffeine
mxp0143_M0059_M_H_combinedV	HILIC_pos	177.1022	6.51	HMDB0000259	NCCc1c[nH]c2ccc(O)cc12	Serotonin
mxp0244_M0031_M_H_combinedV	HILIC_pos	154.0863	8.04	HMDB0000073	NCCc1ccc(O)c(O)c1	Dopamine
mxp0170_M0007_M_combinedV	HILIC_pos	146.1181	7.9	HMDB0000895	CC(=O)OCC[N+](C)(C)C	Acetylcholine


Problem: identifying molecules in the solution. 
Not visible, easily measurable at atomic scale
Affordable manner

Chromatography
Mass spectrometry
Mass spectrometry


Molecules as small as


Running example: some famous molecule
Caffeine
Theobromine
Penicillin
	olive oil fat

Number of arrangements is infinite.


Are we subject to multiple charges?

fragment ions

Bond breaking

Liquid chromatography

Mobile phase: sample is mixed with water and other polar (hydrophilic) solvents (alcohols). 
Stationary phase: hydrophobic (non-polar) arrangements of long-chain alkyl groups (e.g., n-octadecyl or C18).

This is why sugars - hydrophilic - have short retention times and lipids (hydrophobic) have long RTs.

Mass spectrometry

ESI: ionization, vaporization

M/z filtering: quadrupole introduces a radio frequency current so ions "bounce around" the four poles and only a specific m/z range reaches the detector

In TOF, mass is determined by the time and distance the ion tranvels and reaches the detector.

	m = 2t^2 KE / d^2
	KE = 1/2 mv^2 (kinetic energy)


qTOF
	quadrupole determines the mass range
	TOF measures the mass with e.g. 10 ppm sensitivity

detectors
	serve as means of reporting that a particular ion reached the detector
	they induce secondary electrons, which induce more electrons in a cascade, leading to a output of current 



In our latest work, led by <a href="">Sam Goldman</a>, we utilize latest advances in machine learning 
to map fragmentation spectrum into molecules.


MS/MS intro: how are molecules profiled?


	
	gas phase ions
	m/z
	inter gas (argon, helium, N3?)
	MS/MS needs three quads
	Bond breaking
	


MS/MS: data analysis. How do individual peaks link between them? 
	There is a recursive relationship.



Open source MS/MS spectrum for that molecule
Open source example of a spectrum for a known molecule





Machine learning; molecular fingerprints are a digital representation of the molecule.





Latest ML advances:


	Graph neural network to represent molecular fragments.
	Data augmentation: ensures that the predictions for input space make sense (regularization)
	Learning to rank
	

Outlook:
	MS/MS can be run at a large scale
	Peptide discovery in the human microbiome 
	Method not limited to database, could be used to discover antibiotics in biological samples

<img src="img/posts/mist/mist_architecture.png"></img>











<a href="">Sam Goldman</a>
